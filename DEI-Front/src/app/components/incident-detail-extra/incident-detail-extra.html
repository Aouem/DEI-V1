<!-- Indicateur de filtre actif -->
<div *ngIf="startDate || endDate || selectedFamille" class="alert alert-info mb-3">
  <strong>Filtres actifs :</strong>
  <span *ngIf="startDate">Du {{ startDate | date:'dd/MM/yyyy' }}</span>
  <span *ngIf="endDate"> au {{ endDate | date:'dd/MM/yyyy' }}</span>
  <span *ngIf="selectedFamille && selectedFamille !== 'Toutes'"> | Famille : {{ selectedFamille }}</span>
  <button class="btn btn-sm btn-outline-secondary ms-2" (click)="clearFilters()">Effacer les filtres</button>
</div>


<!-- 🔍 Filtre par famille -->
<div class="mb-3 d-flex align-items-center gap-3">
  <label for="familleFilter" class="form-label fw-bold m-0">Filtrer par famille :</label>
  <select id="familleFilter" class="form-select w-auto" [(ngModel)]="selectedFamille" (change)="filterByFamille()">
    <option value="">-- Toutes --</option>
    <option *ngFor="let f of getFamilles()" [value]="f">{{ f }}</option>
  </select>
</div>
<!-- 🔎 Recherche par période -->
<div class="mb-3 d-flex align-items-center gap-3">
  <label for="startDate" class="form-label fw-bold m-0">Du :</label>
  <input id="startDate" type="date" [(ngModel)]="startDate" (change)="filterByFamille()" class="form-control w-auto"/>

  <label for="endDate" class="form-label fw-bold m-0">Au :</label>
  <input id="endDate" type="date" [(ngModel)]="endDate" (change)="filterByFamille()" class="form-control w-auto"/>
</div>
<div class="mb-2 fw-bold">
  Résultats : {{ totalFilteredIncidents }} incident(s) trouvé(s)
</div>


<!-- 🧩 Tableau Filtrer par famille avec pagination -->
<div class="mt-4 stats-section" *ngIf="totalFilteredIncidents > 0">
  <h3 class="stats-title">📋 Liste des incidents filtrés par famille</h3>
  <button class="btn btn-primary mb-2"
          (click)="printTable('familleTable', 'Liste des incidents filtrés par famille')">
    🖨️ Imprimer
  </button>

  <table id="familleTable" class="table table-striped table-bordered text-start">
    <thead class="table-light">
      <tr>
        <th class="text-center">ID</th>
        <th class="text-center">Date</th>
        <th class="text-start">Famille</th>
        <th class="text-start">Sous-famille</th>
        <th class="text-center">Statut</th>
        <th class="text-center">Gravité</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let inc of getPagedFamilleIncidents()">
        <tr *ngFor="let fs of detectFamille(inc)">
          <td class="text-center">{{ inc.id }}</td>
          <td class="text-center">{{ inc.dateDeclaration | date:'short' }}</td>
          <td class="text-start">{{ fs.famille }}</td>
          <td class="text-start">{{ fs.sousFamille }}</td>
          <td class="text-center">{{ getStatusLabel(inc.statut) }}</td>
          <td class="text-center">{{ getGraviteLabel(inc.gravite) }}</td>
        </tr>
      </ng-container>
    </tbody>
  </table>

  <!-- Pagination famille -->
  <nav aria-label="Pagination famille" *ngIf="totalFamillePages > 1">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="goToPage(currentPage - 1)">Précédent</a>
      </li>
      <li class="page-item" *ngFor="let p of totalFamillePagesArray" [class.active]="p === currentPage">
        <a class="page-link" (click)="goToPage(p)">{{ p }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalFamillePages">
        <a class="page-link" (click)="goToPage(currentPage + 1)">Suivant</a>
      </li>
    </ul>
  </nav>

  <!-- Graphiques famille -->
  <div class="row mt-4">
    <!-- Graphique famille par gravité -->
    <div class="col-md-6 chart-container" style="position: relative; height:400px; width:100%" *ngIf="familleGraviteChartData">
      <h4>Famille par Gravité</h4>
      <canvas baseChart
              [data]="familleGraviteChartData"
              [options]="chartOptions"
              [type]="'bar'">
      </canvas>
    </div>
    <!-- Graphique famille par statut -->
    <div class="col-md-6 chart-container" style="position: relative; height:400px; width:100%" *ngIf="familleStatutChartData">
      <h4>Famille par Statut</h4>
      <canvas baseChart
              [data]="familleStatutChartData"
              [options]="chartOptions"
              [type]="'bar'">
      </canvas>
    </div>
  </div>

  <!-- Graphiques sous-famille -->
  <div class="row mt-4">
    <!-- Graphique sous-famille par gravité -->
    <div class="col-md-6 chart-container" style="position: relative; height:400px; width:100%" *ngIf="sousFamilleGraviteChartData">
      <h4>Sous-famille par Gravité</h4>
      <canvas baseChart
              [data]="sousFamilleGraviteChartData"
              [options]="sousFamilleChartOptions"
              [type]="'bar'">
      </canvas>
    </div>

    <!-- Graphique sous-famille par statut -->
    <div class="col-md-6 chart-container" style="position: relative; height:400px; width:100%" *ngIf="sousFamilleStatutChartData">
      <h4>Sous-famille par Statut</h4>
      <canvas baseChart
              [data]="sousFamilleStatutChartData"
              [options]="sousFamilleChartOptions"
              [type]="'bar'">
      </canvas>
    </div>
  </div>
</div>

<!-- 📊 Tableau Statut -->
<div class="mt-4 stats-section" *ngIf="totalIncidents > 0">
  <h3 class="stats-title">📊 Statistiques des incidents par statut 
    <span class="badge bg-secondary">({{ totalIncidents }} incident(s))</span>
  </h3>
  <button class="btn btn-primary mb-2"
          (click)="printTable('statutTable', 'Statistiques des incidents par statut')">
    🖨️ Imprimer
  </button>
  <table id="statutTable" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Statut</th>
        <th>Nombre</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let key of keys(statutCount).slice().sort()">
        <td>{{ key }}</td>
        <td>{{ statutCount[key] }}</td>
        <td>{{ (statutCount[key] / totalIncidents * 100).toFixed(1) }}%</td>
      </tr>
    </tbody>
  </table>
  
  <!-- Graphique pour les statuts -->
  <div class="mt-4 chart-container" style="position: relative; height:400px; width:100%">
    <canvas baseChart 
            [data]="statutChartData" 
            [options]="chartOptions" 
            [type]="'bar'">
    </canvas>
  </div>
</div>

<!-- ⚠️ Tableau Gravité -->
<div class="mt-4 stats-section" *ngIf="totalIncidents > 0">
  <h3 class="stats-title gravite-title">⚠️ Statistiques des incidents par gravité
    <span class="badge bg-secondary">({{ totalIncidents }} incident(s))</span>
  </h3>
  <button class="btn btn-primary mb-2"
          (click)="printTable('graviteTable', 'Statistiques des incidents par gravité')">
    🖨️ Imprimer
  </button>
  <table id="graviteTable" class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Gravité</th>
        <th>Nombre</th>
        <th>%</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let key of sortedGraviteLabels">
        <td>{{ key }}</td>
        <td>{{ graviteCount[key] }}</td>
        <td>{{ (graviteCount[key] / totalIncidents * 100).toFixed(1) }}%</td>
      </tr>
    </tbody>
  </table>
  
  <!-- Graphique pour la gravité -->
  <div class="mt-4 chart-container" style="position: relative; height:400px; width:100%">
    <canvas baseChart 
            [data]="graviteChartData" 
            [options]="chartOptions" 
            [type]="'bar'">
    </canvas>
  </div>
</div>

<!-- 🧮 Matrice Statut/Gravité -->
<div class="mt-4 stats-section" *ngIf="totalIncidents > 0">
  <h3 class="stats-title matrix-title">🧮 Matrice Statut / Gravité
    <span class="badge bg-secondary">({{ totalIncidents }} incident(s))</span>
  </h3>
  <button class="btn btn-primary mb-2"
          (click)="printTable('matrixTable', 'Matrice Statut / Gravité')">
    🖨️ Imprimer
  </button>
  <table id="matrixTable" class="table table-bordered">
    <thead>
      <tr>
        <th>Statut / Gravité</th>
        <th *ngFor="let gravite of sortedGraviteLabels">{{ gravite }}</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let statut of keys(statsMatrix).slice().sort()">
        <td>{{ statut }}</td>
        <td *ngFor="let gravite of sortedGraviteLabels">
          {{ statsMatrix[statut][gravite] || 0 }}
        </td>
      </tr>
      <tr>
     
      </tr>
    </tbody>
  </table>
  
  <!-- Graphique pour la matrice -->
  <div class="mt-4 chart-container" style="position: relative; height:400px; width:100%">
    <canvas baseChart 
            [data]="matrixChartData" 
            [options]="chartOptions" 
            [type]="'bar'">
    </canvas>
  </div>
</div>

<!-- 📈 Indicateur de croissance sur 5 ans -->
<div class="mt-4 stats-section" *ngIf="croissanceParAn.length > 0">
  <h3 class="stats-title">📈 Évolution des incidents par gravité sur 5 ans</h3>
  
  <!-- Tableau des données de croissance -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="table-light">
        <tr>
          <th>Année</th>
          <th *ngFor="let gravite of sortedGraviteLabels">{{ gravite }}</th>
          <th>Total</th>
          <th>Croissance</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let annee of croissanceParAn">
          <td><strong>{{ annee.annee }}</strong></td>
          <td *ngFor="let gravite of sortedGraviteLabels">
            {{ annee.data[gravite] || 0 }}
          </td>
          <td><strong>{{ annee.total }}</strong></td>
          <td [ngClass]="{
            'text-success': annee.croissance > 0,
            'text-danger': annee.croissance < 0,
            'text-muted': annee.croissance === 0
          }">
            <span *ngIf="annee.croissance !== 0">
              {{ annee.croissance > 0 ? '↗' : '↘' }}
              {{ annee.croissance.toFixed(1) }}%
            </span>
            <span *ngIf="annee.croissance === 0">-</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Graphique d'évolution -->
  <div class="chart-container mt-4" style="position: relative; height:500px; width:100%">
    <canvas baseChart 
            [data]="croissanceChartData" 
            [options]="croissanceChartOptions" 
            [type]="'line'">
    </canvas>
  </div>

  <!-- Résumé des tendances -->
  <div class="row mt-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Tendance générale</h5>
          <p class="card-text">
            <span *ngIf="getTendanceGenerale() > 0" class="text-success">
              ↗ Augmentation de {{ getTendanceGenerale().toFixed(1) }}% sur 5 ans
            </span>
           <span *ngIf="getTendanceGenerale() < 0" class="text-danger">
  ↘ Diminution de {{ getTendanceGeneraleAbsolue().toFixed(1) }}% sur 5 ans
</span>
            <span *ngIf="getTendanceGenerale() === 0" class="text-muted">
              → Stabilité sur 5 ans
            </span>
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Gravité la plus fréquente</h5>
          <p class="card-text">{{ getGravitePlusFrequente() }}</p>
        </div>
      </div>
    </div>
  </div>
</div>