<!-- ========================= -->
<!-- Dashboard Complet Incidents - Modernis√© -->
<!-- ========================= -->
<div class="container-fluid p-4">

  <!-- ========================= -->
  <!-- Indicateur de filtres actifs -->
  <!-- ========================= -->
  <div *ngIf="startDate || endDate || selectedFamille" class="alert alert-info d-flex align-items-center justify-content-between mb-4 p-3 shadow rounded-3">
  <div class="d-flex align-items-center gap-2">
  <label for="familleFilter" class="form-label fw-bold m-0">Famille:</label>
  <select id="familleFilter" class="form-select" [(ngModel)]="selectedFamille" (change)="filterByFamille()">
    <option value="">-- Toutes --</option>
    <option *ngFor="let f of getFamilles()" [value]="f">{{ f }}</option>
  </select>
</div>

    <button class="btn btn-outline-secondary btn-sm" (click)="clearFilters()">
      ‚úñ Effacer
    </button>
  </div>

  <!-- ========================= -->
  <!-- Filtres -->
  <!-- ========================= -->
 <div class="row g-3 mb-3 align-items-center">
  <!-- Famille -->
  <div class="col-auto">
    <label for="familleFilter" class="col-form-label fw-bold">Famille :</label>
  </div>
  <div class="col-auto">
    <select id="familleFilter" class="form-select" [(ngModel)]="selectedFamille" (change)="filterByFamille()">
      <option value="">-- Toutes --</option>
      <option *ngFor="let f of getFamilles()" [value]="f">{{ f }}</option>
    </select>
  </div>

  <!-- Du -->
  <div class="col-auto">
    <label for="startDate" class="col-form-label fw-bold">Du :</label>
  </div>
  <div class="col-auto">
    <input id="startDate" type="date" class="form-control" [(ngModel)]="startDate" (change)="filterByFamille()">
  </div>

  <!-- Au -->
  <div class="col-auto">
    <label for="endDate" class="col-form-label fw-bold">Au :</label>
  </div>
  <div class="col-auto">
    <input id="endDate" type="date" class="form-control" [(ngModel)]="endDate" (change)="filterByFamille()">
  </div>
</div>


  <!-- ========================= -->
  <!-- R√©sum√© rapide -->
  <!-- ========================= -->
 <!-- Card Total Incidents -->
<div class="row g-3 text-center mb-4">
  <div class="col-md-4 mx-auto">
    <div class="card shadow-sm p-4 rounded-4 bg-primary text-white hover-shadow-dark">
      <h6 class="mb-2">Total incidents</h6>
      <p class="display-5 fw-bold mb-0">{{ totalIncidents || 0 }}</p>
    </div>
  </div>
</div>


  <!-- ========================= -->
  <!-- Tableau incidents filtr√©s par famille -->
  <!-- ========================= -->
  <div class="card mb-5 shadow-sm rounded-4 p-3" *ngIf="totalFilteredIncidents > 0">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="stats-title">üìã Liste des incidents filtr√©s par famille</h3>
      <button class="btn btn-primary btn-sm" (click)="printTable('familleTable', 'Liste des incidents filtr√©s par famille')">
        üñ®Ô∏è Imprimer
      </button>
    </div>
    <div class="table-responsive">
      <table id="familleTable" class="table table-hover table-striped table-bordered align-middle text-center">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th class="text-start">Famille</th>
            <th class="text-start">Sous-famille</th>
            <th>Statut</th>
            <th>Gravit√©</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let inc of getPagedFamilleIncidents()">
            <tr *ngFor="let fs of detectFamille(inc)" class="hover-highlight">
              <td>{{ inc.id }}</td>
              <td>{{ inc.dateDeclaration | date:'short' }}</td>
              <td class="text-start">{{ fs.famille }}</td>
              <td class="text-start">{{ fs.sousFamille }}</td>
              <td>
                <span class="badge"
                      [ngClass]="{
                        'bg-success': inc.statut === 'Clos',
                        'bg-warning text-dark': inc.statut === 'En cours',
                        'bg-danger': inc.statut === 'Urgent'
                      }">{{ getStatusLabel(inc.statut) }}</span>
              </td>
              <td>
                <span class="badge"
                      [ngClass]="{
                        'bg-info text-dark': inc.gravite === 'Faible',
                        'bg-warning text-dark': inc.gravite === 'Moyenne',
                        'bg-danger': inc.gravite === 'Critique'
                      }">{{ getGraviteLabel(inc.gravite) }}</span>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Pagination famille" *ngIf="totalFamillePages > 1" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="goToPage(currentPage - 1)">Pr√©c√©dent</a>
        </li>
        <li class="page-item" *ngFor="let p of totalFamillePagesArray" [class.active]="p === currentPage">
          <a class="page-link" (click)="goToPage(p)">{{ p }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalFamillePages">
          <a class="page-link" (click)="goToPage(currentPage + 1)">Suivant</a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- ========================= -->
  <!-- Graphiques famille et sous-famille -->
  <!-- ========================= -->
  <div class="row g-4 justify-content-center text-center mb-5">
    <div class="col-md-5" *ngIf="familleGraviteChartData">
      <div class="card shadow-sm p-3 rounded-4">
        <h5 class="card-title">Famille par Gravit√©</h5>
        <canvas baseChart [data]="familleGraviteChartData" [options]="chartOptions" [type]="'bar'"></canvas>
      </div>
    </div>
    <div class="col-md-5" *ngIf="familleStatutChartData">
      <div class="card shadow-sm p-3 rounded-4">
        <h5 class="card-title">Famille par Statut</h5>
        <canvas baseChart [data]="familleStatutChartData" [options]="chartOptions" [type]="'bar'"></canvas>
      </div>
    </div>
    <div class="col-md-5" *ngIf="sousFamilleGraviteChartData">
      <div class="card shadow-sm p-3 rounded-4">
        <h5 class="card-title">Sous-famille par Gravit√©</h5>
        <canvas baseChart [data]="sousFamilleGraviteChartData" [options]="sousFamilleChartOptions" [type]="'bar'"></canvas>
      </div>
    </div>
    <div class="col-md-5" *ngIf="sousFamilleStatutChartData">
      <div class="card shadow-sm p-3 rounded-4">
        <h5 class="card-title">Sous-famille par Statut</h5>
        <canvas baseChart [data]="sousFamilleStatutChartData" [options]="sousFamilleChartOptions" [type]="'bar'"></canvas>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Statistiques Statut et Gravit√© -->
  <!-- ========================= -->
  <div class="row g-4 mb-5">
    <div class="col-lg-6" *ngIf="totalIncidents > 0">
      <div class="card shadow-sm p-3 rounded-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>üìä Statistiques par Statut</h5>
          <button class="btn btn-sm btn-primary" (click)="printTable('statutTable', 'Statistiques des incidents par statut')">üñ®Ô∏è</button>
        </div>
        <div class="table-responsive">
          <table id="statutTable" class="table table-striped table-bordered text-center mb-3">
            <thead class="table-light">
              <tr><th>Statut</th><th>Nombre</th><th>%</th></tr>
            </thead>
            <tbody>
              <tr *ngFor="let key of keys(statutCount).slice().sort()">
                <td>{{ key }}</td>
                <td>{{ statutCount[key] }}</td>
                <td>{{ (statutCount[key] / totalIncidents * 100).toFixed(1) }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
        <canvas baseChart [data]="statutChartData" [options]="chartOptions" [type]="'bar'"></canvas>
      </div>
    </div>
    <div class="col-lg-6" *ngIf="totalIncidents > 0">
      <div class="card shadow-sm p-3 rounded-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>‚ö†Ô∏è Statistiques par Gravit√©</h5>
          <button class="btn btn-sm btn-primary" (click)="printTable('graviteTable', 'Statistiques des incidents par gravit√©')">üñ®Ô∏è</button>
        </div>
        <div class="table-responsive">
          <table id="graviteTable" class="table table-striped table-bordered text-center mb-3">
            <thead class="table-light">
              <tr><th>Gravit√©</th><th>Nombre</th><th>%</th></tr>
            </thead>
            <tbody>
              <tr *ngFor="let key of sortedGraviteLabels">
                <td>{{ key }}</td>
                <td>{{ graviteCount[key] }}</td>
                <td>{{ (graviteCount[key] / totalIncidents * 100).toFixed(1) }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
        <canvas baseChart [data]="graviteChartData" [options]="chartOptions" [type]="'bar'"></canvas>
      </div>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Matrice Statut/Gravit√© -->
  <!-- ========================= -->
  <div *ngIf="totalIncidents > 0" class="mb-5">
    <div class="card shadow-sm p-3 rounded-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>üßÆ Matrice Statut / Gravit√©</h5>
        <button class="btn btn-sm btn-primary" (click)="printTable('matrixTable', 'Matrice Statut / Gravit√©')">üñ®Ô∏è</button>
      </div>
      <div class="table-responsive">
        <table id="matrixTable" class="table table-bordered text-center mb-3">
          <thead class="table-light">
            <tr>
              <th>Statut / Gravit√©</th>
              <th *ngFor="let gravite of sortedGraviteLabels">{{ gravite }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let statut of keys(statsMatrix).slice().sort()">
              <td>{{ statut }}</td>
              <td *ngFor="let gravite of sortedGraviteLabels">{{ statsMatrix[statut][gravite] || 0 }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <canvas baseChart [data]="matrixChartData" [options]="chartOptions" [type]="'bar'"></canvas>
    </div>
  </div>

  <!-- ========================= -->
  <!-- √âvolution sur 5 ans -->
  <!-- ========================= -->
  <div class="card shadow-sm p-4 rounded-4 mb-5" *ngIf="croissanceParAn.length > 0">
    <h3 class="mb-3">üìà √âvolution des incidents par gravit√© ({{ croissanceParAn[0]?.annee }}-{{ croissanceParAn[croissanceParAn.length-1]?.annee }})</h3>

    <div class="alert alert-warning" *ngIf="croissanceParAn[croissanceParAn.length-1]?.annee > currentYear">
      ‚ö†Ô∏è Donn√©es incluant des ann√©es futures (donn√©es de test)
    </div>

    <!-- Tableau croissance -->
    <div class="table-responsive mb-4">
      <table class="table table-striped table-bordered">
        <thead class="table-light">
          <tr>
            <th>Ann√©e</th>
            <th *ngFor="let gravite of sortedGraviteLabels">{{ gravite }}</th>
            <th>Total</th>
            <th>Croissance</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let annee of croissanceParAn">
            <td><strong>{{ annee.annee }}</strong></td>
            <td *ngFor="let gravite of sortedGraviteLabels">{{ annee.data[gravite] || 0 }}</td>
            <td><strong>{{ annee.total }}</strong></td>
            <td [ngClass]="{
                  'text-success': annee.croissance > 0,
                  'text-danger': annee.croissance < 0,
                  'text-muted': annee.croissance === 0
                }">
              <span *ngIf="annee.croissance !== 0">
                {{ annee.croissance > 0 ? '‚Üó' : '‚Üò' }}
                {{ annee.croissance.toFixed(1) }}%
              </span>
              <span *ngIf="annee.croissance === 0">-</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Graphique -->
    <div class="chart-container mb-4" style="position: relative; height:450px; width:100%">
      <canvas baseChart [data]="croissanceChartData" [options]="croissanceChartOptions" [type]="'line'"></canvas>
    </div>

    <!-- Cartes r√©sum√© tendance -->
    <div class="row g-3 text-center">
      <div class="col-md-6">
        <div class="card p-3 shadow-sm rounded-4">
          <h6>Tendance g√©n√©rale</h6>
          <p class="mb-0" [ngClass]="{
            'text-success': getTendanceGenerale() > 0,
            'text-danger': getTendanceGenerale() < 0,
            'text-muted': getTendanceGenerale() === 0
          }">
            <span *ngIf="getTendanceGenerale() > 0">‚Üó Augmentation de {{ getTendanceGenerale().toFixed(1) }}%</span>
            <span *ngIf="getTendanceGenerale() < 0">‚Üò Diminution de {{ getTendanceGeneraleAbsolue().toFixed(1) }}%</span>
            <span *ngIf="getTendanceGenerale() === 0">‚Üí Stabilit√©</span>
          </p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-3 shadow-sm rounded-4">
          <h6>Gravit√© la plus fr√©quente</h6>
          <p class="mb-0">{{ getGravitePlusFrequente() }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- Styles additionnels modernes -->
<!-- ========================= -->
<style>
  .hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    transition: 0.3s;
  }
  .hover-highlight:hover {
    background-color: rgba(0,123,255,0.05);
    transition: 0.3s;
  }
  .pagination .page-item.active .page-link {
    background-color: #0d6efd;
    color: #fff;
  }
  .pagination .page-link {
    cursor: pointer;
  }
</style>
